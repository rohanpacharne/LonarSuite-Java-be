package com.lonar.asn.dao;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.jdo.annotations.Transactional;
import javax.persistence.EntityManager;
import javax.persistence.ParameterMode;
import javax.persistence.PersistenceContext;
import javax.persistence.StoredProcedureQuery;
import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.PropertySource;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.core.BeanPropertyRowMapper;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import com.lonar.asn.model.AsnApproval;
import com.lonar.asn.model.BusinessException;
import com.lonar.asn.model.CodeMaster;
import com.lonar.asn.model.LtPoShipment;
import com.lonar.asn.model.LtShipmentApprovalHistory;
import com.lonar.asn.model.LtShipmentHeaders;
import com.lonar.asn.model.LtShipmentLines;
import com.lonar.asn.model.ProcedureCall;
import com.lonar.asn.model.SubmitAsn;
import com.lonar.asn.repository.LtShipmentLinesRepository;

@Repository
@PropertySource(value = "classpath:queries/asnQueries.properties", ignoreResourceNotFound = true)
public class LtShipmentHeaderDaoImpl implements LtShipmentHeaderDao, CodeMaster{

	@Autowired
	private Environment env;
	
	@Autowired
	LtShipmentLinesRepository ltShipmentLinesRepository;
	
	@PersistenceContext(name = "em")
	private EntityManager em;
	
	private JdbcTemplate jdbcTemplate;
	
	private JdbcTemplate getJdbcTemplate() {
		return jdbcTemplate;
	}
	
	@Autowired
	public void setDataSource(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate(dataSource);
	} 
	
	
	@Override
	public List<String> getListOfStr() throws BusinessException {
		List<String> listStr = new ArrayList<>();
		listStr.add("ABC");
		listStr.add("PQR");
		listStr.add("XYZ");
		return listStr;
	}

	@Override
	public Long getAsnHeaderDataCount(LtShipmentHeaders input) throws BusinessException {
		String query = env.getProperty("asnDataTableDataCount");
		
		String shipmentNumber=null;
		if(input.getShipmentNum()!=null && !input.getShipmentNum().equals(""))
		{shipmentNumber="%"+input.getShipmentNum().trim().toUpperCase() + "%";}
	   
		if(input.getShippedDate() == null )
		{
			input.setShippedDate(null);
		}
		   
		String vendorName=null;
		if(input.getVendorName()!=null && !input.getVendorName().equals(""))
		{vendorName="%"+input.getVendorName().trim().toUpperCase()+"%";}
			
		String vendorAddress=null;
		if(input.getVendorAdd()!=null &&  !input.getVendorAdd().equals("")) 
		{vendorAddress="%"+input.getVendorAdd().trim().trim().toUpperCase()+"%";}
		   
		String status=null;
		if(input.getApprovalStatus()!=null && !input.getApprovalStatus().equals(""))
		{status="%"+input.getApprovalStatus().trim().trim().toUpperCase()+"%";}
		  
		   
		String count  = (String)getJdbcTemplate().queryForObject(
				query, new Object[] {input.getVendorId(), shipmentNumber, input.getShippedDate(), 
						vendorName, vendorAddress, status}, String.class);

		return Long.parseLong(count);
	}

	@Override
	public List<LtShipmentHeaders> getAsnHeaderDataTableDetails(LtShipmentHeaders input) throws BusinessException {
		String query = env.getProperty("asnDataTableQueries");
		
		String shipmentNumber=null;
		if(input.getShipmentNum()!=null && !input.getShipmentNum().equals(""))
		{shipmentNumber="%"+input.getShipmentNum().trim().toUpperCase() + "%";}
	   
		if(input.getShippedDate() == null )
		{
			input.setShippedDate(null);
		}
		   
		String vendorName=null;
		if(input.getVendorName()!=null && !input.getVendorName().equals(""))
		{vendorName="%"+input.getVendorName().trim().toUpperCase()+"%";}
			
		String vendorAddress=null;
		if(input.getVendorAdd()!=null &&  !input.getVendorAdd().equals("")) 
		{vendorAddress="%"+input.getVendorAdd().trim().trim().toUpperCase()+"%";}
		   
		String status=null;
		if(input.getApprovalStatus()!=null && !input.getApprovalStatus().equals(""))
		{status="%"+input.getApprovalStatus().trim().trim().toUpperCase()+"%";}
			
		if(input.getColumnNo()==0) {
			input.setColumnNo(7);
		}
		
			List<LtShipmentHeaders> list = (List<LtShipmentHeaders>) 
					jdbcTemplate.query(query , new Object[]{input.getVendorId(), shipmentNumber, input.getShippedDate(), 
							vendorName, vendorAddress, status,
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo(),
							input.getStart()+input.getLength(),input.getStart()},
				 new  BeanPropertyRowMapper<LtShipmentHeaders>(LtShipmentHeaders.class));
				return list;
	}

	@Override
	public LtShipmentHeaders getByAsnHeaderId(Long id) throws BusinessException {
		String query = env.getProperty("getByAsnHeaderId");
		List<LtShipmentHeaders> list=   jdbcTemplate.query(query, new Object[]{ id}, 
				 new BeanPropertyRowMapper<LtShipmentHeaders>(LtShipmentHeaders.class));
		if(list.isEmpty())
			return null;
		else
			return list.get(0);
	}

	@Override
	public List<LtShipmentLines> getAsnLinesByAsnHeaderId(Long id) throws BusinessException {
		String query = env.getProperty("getAsnLinesByAsnHeaderId");
		List<LtShipmentLines> list=   jdbcTemplate.query(query, new Object[]{ id}, 
				 new BeanPropertyRowMapper<LtShipmentLines>(LtShipmentLines.class));
		return list;
	}

	@Override
	public boolean updateLines(LtShipmentLines ltShipmentLines) throws BusinessException {
		String query = "UPDATE LT_SHIPMENT_LINES SET QUANTITY_SHIPPED = ? WHERE SHIPMENT_LINE_ID = ? "
				+ " AND SHIPMENT_HEADER_ID = ? AND LAST_UPDATE_DATE = ? ";
		int res = jdbcTemplate
				.update(query,ltShipmentLines.getQuantityShipped(),ltShipmentLines.getShipmentLineId(),
						ltShipmentLines.getShipmentHeaderId(),new Date());
				
				if (res != 0)
					return true;
				else
					return false;
	}

	@Override
	public Long getAsnHeaderDataCountByLocation(LtShipmentHeaders input, Long locationId)
			throws BusinessException {
		String query = env.getProperty("asnDataTableDataCountByLocation");
		
		String shipmentNumber=null;
		if(input.getShipmentNum()!=null && !input.getShipmentNum().equals(""))
		{shipmentNumber="%"+input.getShipmentNum().trim().toUpperCase() + "%";}
	   
		if(input.getShippedDate() == null )
		{
			input.setShippedDate(null);
		}
		   
		String vendorName=null;
		if(input.getVendorName()!=null && !input.getVendorName().equals(""))
		{vendorName="%"+input.getVendorName().trim().toUpperCase()+"%";}
			
		String vendorAddress=null;
		if(input.getVendorAdd()!=null &&  !input.getVendorAdd().equals("")) 
		{vendorAddress="%"+input.getVendorAdd().trim().trim().toUpperCase()+"%";}
		   
		String status=null;
		if(input.getApprovalStatus()!=null && !input.getApprovalStatus().equals(""))
		{status="%"+input.getApprovalStatus().trim().trim().toUpperCase()+"%";}
		  
		   
		String count  = (String)getJdbcTemplate().queryForObject(
				query, new Object[] {locationId, shipmentNumber, input.getShippedDate(), 
						vendorName, vendorAddress, status}, String.class);

		return Long.parseLong(count);
	}

	@Override
	public List<LtShipmentHeaders> getAsnHeaderDataTableDetailsByLocation(LtShipmentHeaders input, Long locationId)
			throws BusinessException {
		String query = env.getProperty("asnDataTableQueriesByLocation");
		
		String shipmentNumber=null;
		if(input.getShipmentNum()!=null && !input.getShipmentNum().equals(""))
		{shipmentNumber="%"+input.getShipmentNum().trim().toUpperCase() + "%";}
	   
		if(input.getShippedDate() == null )
		{
			input.setShippedDate(null);
		}
		   
		String vendorName=null;
		if(input.getVendorName()!=null && !input.getVendorName().equals(""))
		{vendorName="%"+input.getVendorName().trim().toUpperCase()+"%";}
			
		String vendorAddress=null;
		if(input.getVendorAdd()!=null &&  !input.getVendorAdd().equals("")) 
		{vendorAddress="%"+input.getVendorAdd().trim().trim().toUpperCase()+"%";}
		   
		String status=null;
		if(input.getApprovalStatus()!=null && !input.getApprovalStatus().equals(""))
		{status="%"+input.getApprovalStatus().trim().trim().toUpperCase()+"%";}
			
		if(input.getColumnNo()==0) {
			input.setColumnNo(0);
		}
	
			List<LtShipmentHeaders> list = (List<LtShipmentHeaders>) 
					jdbcTemplate.query(query , new Object[]{locationId, shipmentNumber, input.getShippedDate(), 
							vendorName, vendorAddress, status,
							input.getStart()+input.getLength(),input.getStart(),
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo(),
							input.getColumnNo(),input.getColumnNo()
							},
				 new  BeanPropertyRowMapper<LtShipmentHeaders>(LtShipmentHeaders.class));
				return list;
	}

	@Override
	public boolean submitAsn(SubmitAsn submitAsn) throws BusinessException {
		
		int res;
		if(submitAsn.getAcceptedBy() !=null) {
			String query2 = " UPDATE LT_SHIPMENT_HEADERS SET APPROVAL_STATUS = ? , LAST_UPDATED_BY = ? ,"
					+ "  LAST_UPDATE_LOGIN = ? , LAST_UPDATE_DATE = ?, ACCEPTED_BY = ? WHERE SHIPMENT_HEADER_ID = ? "
					+ "    ";
			
			 res = jdbcTemplate
						.update(query2,submitAsn.getStatus(),submitAsn.getLastUpdateLogin(),
								submitAsn.getLastUpdateLogin(),new Date(), submitAsn.getAcceptedBy(), submitAsn.getShipmentHeaderId());
		}else {
			 String query = " UPDATE LT_SHIPMENT_HEADERS SET APPROVAL_STATUS = ? , LAST_UPDATED_BY = ? ,"
						+ "  LAST_UPDATE_LOGIN = ? , LAST_UPDATE_DATE = ? WHERE SHIPMENT_HEADER_ID = ? "
						+ "    ";
				
				 res = jdbcTemplate
						.update(query,submitAsn.getStatus(),submitAsn.getLastUpdateLogin(),
								submitAsn.getLastUpdateLogin(),new Date(),submitAsn.getShipmentHeaderId());
		}
				if (res != 0)
					return true;
				else
					return false;
	}

	@Override
	public SubmitAsn getAsnStatusByAsnHeaderId(Long id) throws BusinessException {
		String query = env.getProperty("getAsnStatusByAsnHeaderId");
		List<SubmitAsn> list=   jdbcTemplate.query(query, new Object[]{ id}, 
				 new BeanPropertyRowMapper<SubmitAsn>(SubmitAsn.class));
		if(list.isEmpty())
			return null;
		else
			return list.get(0);
	}

	@Override
	public Long getCountpoShipmentDataTableByVendorId(LtPoShipment input, Long vendorId) throws BusinessException {

		String query = env.getProperty("poShipmentDataTableCount");
		
		String poNumber=null;
		if(input.getPoNumber()!=null && !input.getPoNumber().equals(""))
		{poNumber="%"+input.getPoNumber().trim().toUpperCase() + "%";}
		   
		String poLineId =null;
		if(input.getPoLineId()!=null && !input.getPoLineId().equals(""))
		{poLineId="%"+input.getPoLineId().toString()+"%";}
		
		String shipmentNumber =null;
		if(input.getShipmentNum()!=null && !input.getShipmentNum().equals(""))
		{shipmentNumber="%"+input.getShipmentNum().toString()+"%";}
		
		String itemDescription =null;
		if(input.getProductDescription()!=null &&  !input.getProductDescription().equals("")) 
		{itemDescription="%"+input.getProductDescription().trim().trim().toUpperCase()+"%";}
		
		if(input.getDueDate() == null )
		{
			input.setDueDate(null);
		}
		
		String orderQuantity =null;
		if(input.getQuantityOrdered()!=null && !input.getQuantityOrdered().equals(""))
		{orderQuantity="%"+input.getQuantityOrdered().toString()+"%";}
		
		String quantityRecived =null;
		if(input.getQuantityReceived()!=null && !input.getQuantityReceived().equals(""))
		{quantityRecived="%"+input.getQuantityReceived().toString()+"%";}
		   
		String shipToLocation =null;
		if(input.getShipToLocation()!=null && !input.getShipToLocation().equals(""))
		{shipToLocation="%"+input.getShipToLocation().trim().trim().toUpperCase()+"%";}
		  
		   
		String count  = (String)getJdbcTemplate().queryForObject(
				query, new Object[] {vendorId,
						poNumber, poLineId,itemDescription, shipmentNumber
						, input.getDueDate(), orderQuantity,
						quantityRecived, shipToLocation}, String.class);
		
		return Long.parseLong(count);
		
	}

	@Override
	public List<LtPoShipment> getPoShipmentDataTableByVendorId(LtPoShipment input, Long vendorId)
			throws BusinessException {
		String query = env.getProperty("poShipmentDataTableList");
		
		String poNumber=null;
		if(input.getPoNumber()!=null && !input.getPoNumber().equals(""))
		{poNumber="%"+input.getPoNumber().trim().toUpperCase() + "%";}
		   
		String poLineId =null;
		if(input.getLineNum()!=null && !input.getLineNum().equals(""))
		{poLineId="%"+input.getLineNum().toString()+"%";}
		
		String shipmentNumber =null;
		if(input.getShipmentNum()!=null && !input.getShipmentNum().equals(""))
		{shipmentNumber="%"+input.getShipmentNum().toString()+"%";}
		
		String itemDescription =null;
		if(input.getProductDescription()!=null &&  !input.getProductDescription().equals("")) 
		{itemDescription="%"+input.getProductDescription().trim().trim().toUpperCase()+"%";}
		
		if(input.getDueDate() == null )
		{
			input.setDueDate(null);
		}
		
		String orderQuantity =null;
		if(input.getQuantityOrdered()!=null && !input.getQuantityOrdered().equals(""))
		{orderQuantity="%"+input.getQuantityOrdered().toString()+"%";}
		
		String quantityRecived =null;
		if(input.getQuantityReceived()!=null && !input.getQuantityReceived().equals(""))
		{quantityRecived="%"+input.getQuantityReceived().toString()+"%";}
		   
		String shipToLocation =null;
		if(input.getShipToLocation()!=null && !input.getShipToLocation().equals(""))
		{shipToLocation="%"+input.getShipToLocation().trim().trim().toUpperCase()+"%";}
		
		List<LtPoShipment> list = (List<LtPoShipment>) 
				jdbcTemplate.query(query , new Object[]{
						vendorId,
						poNumber, poLineId, itemDescription,shipmentNumber
						, input.getDueDate(), orderQuantity,
						quantityRecived, shipToLocation,
						input.getColumnNo(),input.getColumnNo(),
						input.getColumnNo(),input.getColumnNo(),
						input.getColumnNo(),input.getColumnNo(),
						input.getColumnNo(),input.getColumnNo(),
						input.getColumnNo(),input.getColumnNo(),
						input.getColumnNo(),input.getColumnNo(),
						input.getColumnNo(),input.getColumnNo(),
						input.getColumnNo(),input.getColumnNo(),
					
						input.getStart()+input.getLength(),input.getStart()},
			 new  BeanPropertyRowMapper<LtPoShipment>(LtPoShipment.class));
		
			return list;
	}
	
	@Override
	@Transactional
	public Long getShipmentSourceIds() throws BusinessException {
		String sql = env.getProperty("shipmentSourceId");
		return jdbcTemplate.queryForObject(sql, Long.class);
	}
	
	// x_status OUT VARCHAR2,x_message OUT VARCHAR2,x_shipment_header_id OUT NUMBER,p_shipment_source_id IN NUMBER

	@Override
	@Transactional
	public ProcedureCall saveAsnHeaderAndLineData(Long sourceId) throws BusinessException {
		ProcedureCall procedureCall= new ProcedureCall();
			StoredProcedureQuery query = em
				    .createStoredProcedureQuery("lt_vpal_asn_pkg.create_asn")
				    .registerStoredProcedureParameter(1, String.class, 
					         ParameterMode.OUT)
				    .registerStoredProcedureParameter(2, String.class, 
				         ParameterMode.OUT)
			        .registerStoredProcedureParameter(3, Long.class, 
			         ParameterMode.OUT)
				    .registerStoredProcedureParameter(4, Long.class, 
					         ParameterMode.IN)
				    .setParameter(4, sourceId);
				query.execute();

				if(query.getOutputParameterValue(1).toString().trim().equals("ERROR")){
					procedureCall.setStatusCode(query.getOutputParameterValue(1).toString().trim());
					procedureCall.setStatusMessage(query.getOutputParameterValue(2).toString().trim());
				}
				else if(query.getOutputParameterValue(1).toString().trim().equals("SUCCESS")){
					procedureCall.setStatusCode("SUCCESS");
					if(query.getOutputParameterValue(2)!=null) {
					procedureCall.setStatusMessage(query.getOutputParameterValue(2).toString());
					}
					procedureCall.setShipmentHeaderId((Long) query.getOutputParameterValue(3));
				}
				return procedureCall;
	}

	@Override
	public boolean deleteAsnLineAttachment(Long id) throws BusinessException {
		int res=jdbcTemplate.update(" DELETE FROM LT_SHIPMENT_ATTACHMENT WHERE SHIPMENT_ATTACHMENT_ID = "
		+ "( SELECT ATTACHMENT FROM LT_SHIPMENT_LINES WHERE SHIPMENT_LINE_ID = ? )",id );	
	
		if(res!=0) {
		int res1=jdbcTemplate.update("UPDATE LT_SHIPMENT_LINES SET ATTACHMENT = ?, LAST_UPDATE_DATE = ?  WHERE SHIPMENT_LINE_ID = ?  "
		, null,new Date(), id);	
		if(res1!=0) {
		return true;
	
		}else {
		return false;
		}
		}
		return false;
	}

	@Override
	public ProcedureCall createInvoiceFromAsn(Long shipmentHeaderId, Long userId) throws BusinessException {
		ProcedureCall procedureCall= new ProcedureCall();
			StoredProcedureQuery query = em
				    .createStoredProcedureQuery("lt_vpal_asn_pkg.create_invoice_from_asn")
				    .registerStoredProcedureParameter(1, Long.class, 
					         ParameterMode.IN)
				    .registerStoredProcedureParameter(2, Long.class, 
				         ParameterMode.IN)
			        .registerStoredProcedureParameter(3, String.class, 
			         ParameterMode.OUT)
				    .registerStoredProcedureParameter(4, String.class, 
					         ParameterMode.OUT)
				    .registerStoredProcedureParameter(5, Long.class, 
					         ParameterMode.OUT)
				    .setParameter(1, shipmentHeaderId)
				    .setParameter(2, userId);
				query.execute();

				if(query.getOutputParameterValue(3).toString().trim().equals("ERROR")){
					procedureCall.setStatusCode(query.getOutputParameterValue(3).toString().trim());
					procedureCall.setStatusMessage(query.getOutputParameterValue(4).toString().trim());
				}
				else if(query.getOutputParameterValue(3).toString().trim().equals("SUCCESS")){
					procedureCall.setStatusCode("SUCCESS");
					if(query.getOutputParameterValue(4)!=null) {
					procedureCall.setStatusMessage(query.getOutputParameterValue(4).toString());
					}
					if(query.getOutputParameterValue(5)!=null) {
						procedureCall.setShipmentHeaderId((Long)query.getOutputParameterValue(5));
						}
					//procedureCall.setShipmentHeaderId((Long) query.getOutputParameterValue(3));
				}
				return procedureCall;
	}

	@Override
	@Transactional
	public boolean updatePoShipmentLines(LtShipmentLines ltShipmentLinesObj) throws BusinessException {
		String query1  = " SELECT SUM(sl.QUANTITY_RECEIVED) as QUANTITY_RECEIVED  FROM LT_SHIPMENT_LINES sl,LT_PO_SHIPMENTS ps " + 
				"				   WHERE ps.PO_SHIPMENT_LINE_ID = sl.PO_SHIPMENT_ID " + 
				"				   AND sl.PO_SHIPMENT_ID = ? AND sl.PO_HEADER_ID = ? AND sl.PO_LINE_ID = ?  ";
		Double count  = getJdbcTemplate().queryForObject(
				query1, new Object[] { ltShipmentLinesObj.getPoShipmentId(), ltShipmentLinesObj.getPoHeaderId(), 
						ltShipmentLinesObj.getPoLineId() }, Double.class);
		
		if(count!=null) {
				String query = " UPDATE LT_PO_SHIPMENTS " + 
				"    SET QUANTITY_RECEIVED =  ? ," + 
				"    QUANTITY_SHIPPED = ?, LAST_UPDATE_DATE = ? WHERE PO_SHIPMENT_LINE_ID = ? AND PO_HEADER_ID = ? " + 
				"				 AND PO_LINE_ID = ? ";
		
				int res = 0;
				res = jdbcTemplate
						.update(query,count,ltShipmentLinesObj.getQuantityShipped(),new Date(),
							ltShipmentLinesObj.getShipmentLineId(),ltShipmentLinesObj.getPoHeaderId(),
						ltShipmentLinesObj.getPoLineId());
		
				if(res!=0) {
					return true;
				}else {
					return false;
				}
		}
		return true;
	}

	@Override
	@Transactional
	public boolean updateRecivedQuantity(LtShipmentLines ltShipmentLinesObj) throws BusinessException {
		String query = " UPDATE LT_SHIPMENT_LINES " + 
				"    SET QUANTITY_RECEIVED =  ? ," + 
				"    QUANTITY_SHIPPED = ? , LAST_UPDATE_DATE = ? WHERE SHIPMENT_LINE_ID = ? AND PO_SHIPMENT_ID = ? AND PO_HEADER_ID = ? " + 
				"				 AND PO_LINE_ID = ? ";
		
				int res = 0;
				res = jdbcTemplate
						.update(query,ltShipmentLinesObj.getQuantityReceived(),ltShipmentLinesObj.getQuantityShipped(),
								new Date(),ltShipmentLinesObj.getShipmentLineId(),ltShipmentLinesObj.getPoShipmentId(),
						ltShipmentLinesObj.getPoHeaderId(),ltShipmentLinesObj.getPoLineId());
				if(res!=0) {
					
					String query1  = " SELECT SUM(sl.QUANTITY_RECEIVED) as QUANTITY_RECEIVED  FROM LT_SHIPMENT_LINES sl,LT_PO_SHIPMENTS ps " + 
							"				   WHERE ps.PO_SHIPMENT_LINE_ID = sl.PO_SHIPMENT_ID " + 
							"				   AND sl.PO_SHIPMENT_ID = ? AND sl.PO_HEADER_ID = ? AND sl.PO_LINE_ID = ?  ";
					Double count  = getJdbcTemplate().queryForObject(
							query1, new Object[] { ltShipmentLinesObj.getPoShipmentId(), ltShipmentLinesObj.getPoHeaderId(), 
									ltShipmentLinesObj.getPoLineId() }, Double.class);
					
					
					
					if(count!=null) {
						String updateQuery = " UPDATE LT_PO_SHIPMENTS " + 
						"    SET QUANTITY_RECEIVED =  ? ," + 
						"    QUANTITY_SHIPPED = ?, LAST_UPDATE_DATE = ? WHERE PO_SHIPMENT_LINE_ID = ? AND PO_HEADER_ID = ? " + 
						"				 AND PO_LINE_ID = ? ";
				
						int res1 = 0;
						res1 = jdbcTemplate
								.update(updateQuery,count,ltShipmentLinesObj.getQuantityShipped(),
										new Date(),ltShipmentLinesObj.getPoShipmentId(),
								ltShipmentLinesObj.getPoHeaderId(),ltShipmentLinesObj.getPoLineId());
				
						if(res1!=0) {
							return true;
						}else {
							return false;
						}
				}
					
					return true;
				}else {
					return false;
				}
		
	}

	@Override
	public List<LtShipmentHeaders> getInprocessAsnList(String asnInprogress) throws BusinessException {
		String query = env.getProperty("getInprocessAsnList");
		List<LtShipmentHeaders> list=   jdbcTemplate.query(query, new Object[]{ asnInprogress.toUpperCase()}, 
				 new BeanPropertyRowMapper<LtShipmentHeaders>(LtShipmentHeaders.class));
		return list;
	}

	@Override
	public AsnApproval getApprovalLevel(Long shipmentHeaderId) throws BusinessException {
		String query = "select   MIN( APPROVAL_LEVEL) as MIN_LEVEL,  CURRENT_APPROVAL_LEVEL ,MODULE_APPROVAL_ID " + 
				" from LT_SHIPMENT_APPROVAL where SHIPMENT_HEADER_ID = ? " + 
				" group by APPROVAL_LEVEL,  CURRENT_APPROVAL_LEVEL ,MODULE_APPROVAL_ID order by MIN_LEVEL";
		
		List<AsnApproval> invoiceApprovalList = jdbcTemplate.query(query, new Object[] {shipmentHeaderId},
				
				new RowMapper<AsnApproval>() {
					public AsnApproval mapRow(ResultSet rs, int arg1) throws SQLException {

						AsnApproval asnApproval = new AsnApproval();

						asnApproval.setApprovalLevel(rs.getString("MIN_LEVEL"));
						asnApproval.setCurrentApprovalLevel(rs.getString("CURRENT_APPROVAL_LEVEL"));
						asnApproval.setModuleApprovalId(rs.getLong("MODULE_APPROVAL_ID"));
						
						
						return asnApproval;
					}
				});
		if(invoiceApprovalList.size()>0)
			return invoiceApprovalList.get(0); 
		else 
			return null;
	}

	@Override
	public List<AsnApproval> getApprovalList(Long shipmentHeaderId, String currentApprovalLevel)
			throws BusinessException {
		String query = " SELECT a.*,'N' as APPROVED_BY_ANYONE " + 
				" FROM LT_SHIPMENT_APPROVAL a  " + 
				" WHERE a.SHIPMENT_HEADER_ID = ? AND a.APPROVAL_LEVEL = nvl(?,a.APPROVAL_LEVEL) ORDER BY a.APPROVAL_LEVEL ASC ";
		List<AsnApproval> list=   jdbcTemplate.query(query, new Object[]{ shipmentHeaderId,currentApprovalLevel}, 
				 new BeanPropertyRowMapper<AsnApproval>(AsnApproval.class));
			return list;
	}

	@Override
	public String getNextApprovalLevel(Long shipmentHeaderId, String currentApprovalLavel) throws BusinessException {
		String query = "select MIN (APPROVAL_LEVEL) AS  CURRENT_APPROVAL_LEVEL " + 
				" from LT_SHIPMENT_APPROVAL where SHIPMENT_HEADER_ID = ? AND APPROVAL_LEVEL > ? AND STATUS <> ? ";
		
		String nextlavel  = (String)getJdbcTemplate().queryForObject(
				query, new Object[] { shipmentHeaderId, currentApprovalLavel,ASN_APPROVED}, String.class);

		return nextlavel;
	}

	@Override
	public boolean upDateStatus(Long shipmentHeaderId, String status, String currentApprovalLevel)
			throws BusinessException {
		int res=0;
		if(currentApprovalLevel!=null)
		{
			String query = env.getProperty("upDateVStatus1");
			 res=jdbcTemplate.update(query,
				        status,new Date(),shipmentHeaderId,currentApprovalLevel,"APPROVED");
		}
		else
		{
			String query = env.getProperty("upDateVStatus2");
			
			res=jdbcTemplate.update(query,
			        status,new Date(),currentApprovalLevel,shipmentHeaderId);
		}
		if(res!=0)
			return true;
		else
			return false;
		
	}

	@Override
	public void updateCurrentApprovalLevel(Long shipmentHeaderId, String currentApprovalLavel)
			throws BusinessException {
		String query = env.getProperty("updateCurrentApprovalLevelV");
		int res=jdbcTemplate.update(query,
				currentApprovalLavel, shipmentHeaderId );
		
	}

	@Override
	public List<AsnApproval> getShipmentApprovalByShipmentId(Long shipmentHeaderId) throws BusinessException {
		String query = env.getProperty("getShipmentApprovalByShipmentId");
		List<AsnApproval> list=   jdbcTemplate.query(query, new Object[]{ shipmentHeaderId}, 
				 new BeanPropertyRowMapper<AsnApproval>(AsnApproval.class));
		return list;
	}

	@Override
	public boolean updateStatusApproval(LtShipmentApprovalHistory approvalHistory) throws BusinessException {
		 
		int res=0;	
		if(approvalHistory.getEmployeeId()!=null ) 
		{
			String query = " UPDATE LT_SHIPMENT_APPROVAL "
			+" SET  Status= ? , LAST_UPDATE_DATE = ?,LAST_UPDATED_BY=? " 
			+" WHERE SHIPMENT_HEADER_ID = ?  AND (APPROVAL_ID = ? OR DELEGATION_ID = ?) ";
			
			res = jdbcTemplate.update(query,
					approvalHistory.getStatus(),new Date(),approvalHistory.getLastUpdateLogin(),
					approvalHistory.getShipmentHeaderId(), approvalHistory.getEmployeeId(),approvalHistory.getEmployeeId());
		}
	 
		if(res!=0)
			return true;
		else
			return false;
	}

	@Override
	public String getCurrLevelByShipmentApprovalId(Long shipmentApprovalId) throws BusinessException {
		String query = env.getProperty("getCurrLevelByShipmentApprovalId");
		
		String nextlavel  = (String)getJdbcTemplate().queryForObject(
				query, new Object[] { shipmentApprovalId}, String.class);

		return nextlavel;
	}

	@Override
	public boolean submitForApproval(Date submissionDate, Long shipmentHeaderId, String status, Date approvedDate,
			Long lastUpdateLogin) throws BusinessException {
		int res=0;
		if(submissionDate!=null)
		{
			String query = env.getProperty("submitShipmentForApproval1");
			res=jdbcTemplate.update(query,status,new Date(),lastUpdateLogin,shipmentHeaderId);
			
		}
		else
		{
			String query = env.getProperty("submitShipmentForApproval2");
			 res=jdbcTemplate.update(query,status,new Date(),lastUpdateLogin,shipmentHeaderId);
		}
		if(res!=0)
			return true;
		else
			return false;
	}

	@Override
	public boolean checkStatusIsPending(Long shipmentId, Long approvalId) throws BusinessException {
		String query = env.getProperty("checkShipmentStatusIsPending"); 
		List<AsnApproval> list=   jdbcTemplate.query(query, new Object[]{shipmentId, approvalId,approvalId}, 
			 new BeanPropertyRowMapper<AsnApproval>(AsnApproval.class)); 

		if(list.size() > 0)
			return true;
		else
			return false;
	}

	@Override
	public AsnApproval getShipmentApproval(Long shipmentId, Long apprId) throws BusinessException {
		String query = env.getProperty("getShipmentApprovalByShipmentIdAndApproverId");
		List<AsnApproval> list=   jdbcTemplate.query(query, new Object[]{ shipmentId,apprId }, 
				 new BeanPropertyRowMapper<AsnApproval>(AsnApproval.class)); 
		if(list.isEmpty())
			return null;
		else 
		 return list.get(0);
	}

	@Override
	public List<LtShipmentApprovalHistory> getApprovalHistoryByShipmentId(Long shipmentHeaderId)
			throws BusinessException {
		String query = env.getProperty("getShipmentApprovalHistoryByShipmentId");
		List<LtShipmentApprovalHistory> list=   jdbcTemplate.query(query, new Object[]{ shipmentHeaderId }, 
				 new BeanPropertyRowMapper<LtShipmentApprovalHistory>(LtShipmentApprovalHistory.class));
		return list; 
	}

	@Override
	public boolean saveRemark(LtShipmentApprovalHistory ltShipmentApprovalHistory) throws BusinessException {
		int res = jdbcTemplate
				.update("INSERT INTO LT_SHIPMENT_APPROVAL_HISTORY "
						+ " (SHIPMENT_APPROVAL_HISTORY_ID,SHIPMENT_APPROVAL_ID,EMPLOYEE_ID, "
						+ " STATUS,NOTE,LAST_UPDATE_DATE,SHIPMENT_HEADER_ID,REMARK,USER_TYPE,VENDOR_ID ) "
						+ " VALUES(LT_SHIPMENT_APPROVAL_HISTORY_S.NEXTVAL,?,?,?,?,?,?,?,?,?) ",

				//ltExpenseApprovalHistory.getVendorApprovalHistoryId(),
						ltShipmentApprovalHistory.getShipmentApprovalId(),
						ltShipmentApprovalHistory.getEmployeeId(),
						ltShipmentApprovalHistory.getStatus(),
						ltShipmentApprovalHistory.getNote(),
						new Date(),
						ltShipmentApprovalHistory.getShipmentHeaderId(),
						ltShipmentApprovalHistory.getRemark(),
						ltShipmentApprovalHistory.getUserType(),
						ltShipmentApprovalHistory.getVendorId());
				
				if (res != 0)
					return true;
				else
					return false;
	}
}
